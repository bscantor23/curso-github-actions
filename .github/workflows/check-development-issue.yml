name: Resumen de cambios en release

on:
  release:
    types: [published]

jobs:
  release-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      repository-projects: write
    steps:
      - name: Generar resumen de cambios
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const rel = context.payload.release;
            if (!rel) {
              core.setFailed('No release en payload');
              return;
            }
            const { owner, repo } = context.repo;
            const tag = rel.tag_name;

            // Obtener commits
            let commitsResp;
            try {
              commitsResp = await github.rest.repos.listCommits({
                owner,
                repo,
                sha: tag,
                per_page: 50
              });
            } catch (e) {
              core.setFailed('Error listando commits: ' + e.message);
              return;
            }

            const prNumbers = new Set();
            const issueNumbers = new Set();

            for (const commit of commitsResp.data) {
              try {
                const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner,
                  repo,
                  commit_sha: commit.sha
                });
                for (const pr of prs.data) {
                  prNumbers.add(pr.number);
                  const refs = (pr.body || '').match(/#(\d+)/g) || [];
                  for (const r of refs) issueNumbers.add(r.slice(1));
                }
              } catch (e) {
                core.warning('PRs commit ' + commit.sha + ' error: ' + e.message);
              }
            }

            let summary = `## Cambios en el release ${tag}\n\n`;
            summary += `### Pull Requests incluidos:\n`;
            summary += prNumbers.size
              ? [...prNumbers].map(n => `- PR #${n}`).join('\n') + '\n'
              : '- (Ninguno)\n';
            summary += `\n### Issues referenciados:\n`;
            summary += issueNumbers.size
              ? [...issueNumbers].map(n => `- Issue #${n}`).join('\n') + '\n'
              : '- (Ninguno)\n';
            summary += '\n---\nGenerado autom√°ticamente.\n';

            const newBody = rel.body ? rel.body + '\n\n' + summary : summary;
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: rel.id,
              body: newBody
            });
            core.notice('Resumen agregado al release.');